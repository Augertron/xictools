#! /bin/sh

# Usage:  ./cleanold [-t]
#
# This will remove all pre-4.3 packages, but the user is given the
# option of saving existing Xic/WRspice installations into the Safe
# Install framework.  Existing Safe Installs are preserved.

process_rpm_dist ()
{
    prog=$1
    dist=$2
    dryrun=$3

    loc=$(rpm -ql $dist | grep xictools/$prog\$)
    if [ $prog = xic -o $prog = wrspice ]; then
        if [ $(echo $dist | grep gen4) = $dist ]; then
            echo
            echo Reverting Safe Install linking
            echo "cd $loc/..; rm $prog; mv -f $prog.current $prog"
            if [ $dryrun = no ]; then
                (cd $loc/..; rm $prog; mv -f $prog.current $prog)
            fi
            echo
            echo -n ">>>  Save $loc ? [n] "
            read foo
            if [ x$foo = xy -o x$foo = xyes ]; then
                vstr=$($loc/bin/$prog --v)
                set -- $vstr
                vstr=$1
                echo
                echo Saving $prog-$vstr
                echo "cd $loc/..; cp -prf $prog $prog-$vstr"
                if [ $dryrun = no ]; then
                    (cd $loc/..; cp -prf $prog $prog-$vstr)
                fi
            fi
            echo
            echo "***IMPORTANT!  Remove $loc/bin from your search path. ***"
            echo
        fi
    fi

    echo
    echo Removing package $a
    echo rpm -e $a
    if [ $dryrun = no ]; then
        rpm -e $a
    fi
}

process_osx_dist ()
{
    prog=$1
    dist=$2
    dryrun=$3

    # Apple packages aren't relocatable.
    loc=/usr/local/xictools

    if [ $prog = xic -o $prog = wrspice ]; then
        echo
        echo Reverting Safe Install linking
        echo "cd $loc; rm $prog; mv -f $prog.current $prog"
        if [ $dryrun = no ]; then
            (cd $loc; rm $prog; mv -f $prog.current $prog)
        fi
        echo
        echo -n ">>>  Save $loc/$prog ? [n] "
        read foo
        if [ x$foo = xy -o x$foo = xyes ]; then
            vstr=$($loc/$prog/bin/$prog --v)
            set -- $vstr
            vstr=$1
            echo
            echo Saving $prog-$vstr
            echo "cd $loc; cp -prf $prog $prog-$vstr"
            if [ $dryrun = no ]; then
                (cd $loc; cp -prf $prog $prog-$vstr)
            fi
        fi
        echo
        echo "***IMPORTANT!  Remove $loc/$prog/bin from your search path. ***"
        echo
    fi

    echo
    echo Removing package $a
    case $prog in
    xic)
        if [ $dryrun = yes ]; then
            echo rm -rf $loc/$prog
            echo pkgutil --forget $dist
        else
            rm -rf $loc/$prog
            pkgutil --forget $dist
        fi
        ;;
    wrspice)
        if [ $dryrun = yes ]; then
            echo rm -rf $loc/$prog
            echo pkgutil --forget $dist
        else
            rm -rf $loc/$prog
            pkgutil --forget $dist
        fi
        ;;
    xt_accs)
        if [ $dryrun = yes ]; then
            echo rm -rf $loc/mozy
            echo rm -f $loc/bin/mozy
            echo rm -f $loc/bin/xeditor
            echo rm -f $loc/bin/httpget
            echo rm -f $loc/bin/hlp2html
            echo rm -f $loc/bin/hlpsrv
            echo rm -f $loc/bin/fcpp
            echo rm -f $loc/bin/lstpack
            echo rm -f $loc/bin/lstunpack
            echo pkgutil --forget $dist
        else
            rm -rf $loc/mozy
            rm -f $loc/bin/mozy
            rm -f $loc/bin/xeditor
            rm -f $loc/bin/httpget
            rm -f $loc/bin/hlp2html
            rm -f $loc/bin/hlpsrv
            rm -f $loc/bin/fcpp
            rm -f $loc/bin/lstpack
            rm -f $loc/bin/lstunpack
            pkgutil --forget $dist
        fi
        ;;
    xtlserv)
        if [ $dryrun = yes ]; then
            echo rm -f $loc/license/README
            echo rm -f $loc/bin/xtlserv
            echo rm -f $loc/bin/xtjobs
            echo pkgutil --forget $dist
        else
            rm -f $loc/license/README
            rm -f $loc/bin/xtlserv
            rm -f $loc/bin/xtjobs
            pkgutil --forget $dist
        fi
        ;;
    esac
}

if [ -n "$COMSPEC" ]; then
    if [ -n "$(expr match $COMSPEC '.*\(\.exe\)')" ]; then
        ../util/cleanold.bat $*
        exit $?
    fi
fi

dryrun=no
if [ x$1 = x-t ]; then
    dryrun=yes
    shift
fi


if [ $(uname) = Darwin ]; then
    xiclist=$(rpm -qa | grep "^XicTools\.Xic\.")
    wrslist=$(rpm -qa | grep "^XicTools\.WRspice\.")
    acslist=$(rpm -qa | grep "^XicTools\.Accs\.")
    srvlist=$(rpm -qa | grep "^XicTools\.Xtlserv\.")

    for a in $xiclist; do
        process_osx_dist xic $a $dryrun
    done

    for a in $wrslist; do
        process_osx_dist wrspice $a $dryrun
    done

    for a in $acslist; do
        process_osx_dist xt_accs $a $dryrun
    done

    for a in $srvlist; do
        process_osx_dist xtlserv $a $dryrun
    done
    exit 0
exit

command -v rpm 2>&1 /dev/null
if [ $? = 0 ]; then
    xiclist=$(rpm -qa | grep "^xic-")
    wrslist=$(rpm -qa | grep "^wrspice-")
    acslist=$(rpm -qa | grep "^xt_accs-")
    srvlist=$(rpm -qa | grep "^xtlserv-")

    for a in $xiclist; do
        process_rpm_dist xic $a $dryrun
    done

    for a in $wrslist; do
        process_rpm_dist wrspice $a $dryrun
    done

    for a in $acslist; do
        process_rpm_dist xt_accs $a $dryrun
    done

    for a in $srvlist; do
        process_rpm_dist xtlserv $a $dryrun
    done
    exit 0
fi

echo "Sorry, I can't find the rpm program, and nobody has taught me"
echo "how to use anything else.  You're on your own for now, bub."
exit 1

