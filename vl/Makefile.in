#######################################################################
LOCATION = vl
#######################################################################

# Below are the recognized CFLAGS defines.  The configure script
# defines some or all of these in VL_DEFS.
#
# -DHAVE_GETTIMEOFDAY   | library has gettimeofday()
# -DHAVE_TIMES          | library has times()
# -DHAVE_VSNPRINTF      | library has vsnprintf()

VERSION = `./version vl`

prefix = @prefix@
CXX = @CXX@
CC = @CC@
LINKCC = @LINKCC@
CFLAGS = @CFLAGS@ @VL_DEFS@ @UFLAGS@
YACC = @YACC@
LEX = @LEX@
OSNAME = @OSNAME@
DEPEND_PROG = @DEPEND_PROG@ @CFLAGS@ @VL_DEFS@
INSTALL = @INSTALL@
STDCLIB = @STDCLIB@
AR = @AR@
RANLIB = @RANLIB@
NTSUFFIX = @NTSUFFIX@
FILTER = @FILTER@
TOOLROOT = @TOOLROOT@

BASE = ../xt_base
INCLUDE = -I.

CCFILES = vl_data.cc vl_expr.cc vl_gate.cc vl_obj.cc vl_parse.cc vl_print.cc \
  vl_sim.cc vl_st.cc vl_sys.cc
OTHERS = verilog.l verilog.y vl_defs.h vl_list.h vl_st.h vl_types.h main.cc \
  Makefile.in configure.in README
COBJS = verilog_yacc.o verilog_lex.o $(CCFILES:.cc=.o)

INSTALL_BIN    = $(INSTALL) -s -c -m 0755
INSTALL_SCRIPT = $(INSTALL) -c -m 0755
INSTALL_LIB    = $(INSTALL) -c -m 0644
INSTALL_LIB_RO = $(INSTALL) -c -m 0444

LIB_TARGET = libvlog.a

all: $(LIB_TARGET) vl

vl: randval.h randval.cc $(COBJS) randval.o main.o
	$(LINKCC) -o $@ main.o $(COBJS) randval.o $(STDCLIB) -lm;

$(LIB_TARGET): randval.h $(COBJS)
	@if [ -f $(LIB_TARGET) ]; then \
	    rm -f $(LIB_TARGET); \
	fi
	$(AR) cr $(LIB_TARGET) $(COBJS)
	$(RANLIB) $(LIB_TARGET)

.cc.o:
	$(CXX) -c $(CFLAGS) $(INCLUDE) -DVL_VERSION=\"$(VERSION)\" $*.cc

randval.cc: $(BASE)/miscutil/randval.cc
	cp -pf $(BASE)/miscutil/randval.cc .

randval.h: $(BASE)/include/miscutil/randval.h
	cp -pf $(BASE)/include/miscutil/randval.h .

clean:
	-rm -f *.o *.a vl vl.exe randval.cc randval.h

distclean: clean
	cd packages; $(MAKE) distclean
	-rm -f verilog_yacc.cc verilog_yacc.h verilog_lex.cc
	-rm -f config.cache config.h config.log config.status Makefile

# yacc/lex rules
verilog_yacc.cc verilog_yacc.h: verilog.y vl_defs.h vl_list.h vl_st.h \
    vl_types.h
	$(YACC) -d verilog.y
	@if [ -f verilog.tab.c ]; then \
	    mv -f verilog.tab.c verilog_yacc.cc; \
	    mv -f verilog.tab.h verilog_yacc.h; \
	else \
	    mv -f y.tab.c verilog_yacc.cc; \
	    mv -f y.tab.h verilog_yacc.h; \
	fi

verilog_lex.cc: verilog.l verilog_yacc.h vl_defs.h vl_list.h vl_st.h vl_types.h
	$(LEX) verilog.l
	@mv -f lex.yy.c verilog_lex.cc

depend: randval.cc randval.h
	@echo depending in $(LOCATION)
	@if [ x$(DEPEND_DONE) = x ]; then \
	    echo DEPEND_DONE = 1 >> Makefile; \
	    $(DEPEND_PROG) $(INCLUDE) main.cc $(CCFILES) \
  $(FILTER) >> Makefile; \
	fi

#######################################################################
####### Installation ##################################################

INSTALL_PREFIX ?= $(prefix)
dst_lib = $(INSTALL_PREFIX)/$(TOOLROOT)
dst_bin = $(INSTALL_PREFIX)/$(TOOLROOT)/bin

install: install_test install_clean install_bin install_lib install_examples

install_bin: $(dst_bin)
install_lib: $(dst_lib)/vl
install_examples: $(dst_lib)/vl/examples

install_test::
	@if [ $(INSTALL_PREFIX) = $prefix ]; then \
	    echo "No!  Use pagkage to install!"; \
	    exit 1; \
	fi

install_clean::
	-@rm -f $(dst_bin)/vl$(NTSUFFIX)
	-@rm -rf $(dst_lib)

$(dst_bin)::
	@$(BASE)/util/mkdirpth $@
	$(INSTALL_BIN) vl$(NTSUFFIX) $@

$(dst_lib)/vl::
	@$(BASE)/util/mkdirpth $@
	$(INSTALL_LIB) README $@
	$(INSTALL_LIB) ChangeLog $@
	@$(BASE)/util/mkdirpth $@/lib
	$(INSTALL_LIB) libvlog.a $@/lib

$(dst_lib)/vl/examples::
	@$(BASE)/util/mkdirpth $@/book
	cp -pr examples_book/* $@/book
	@$(BASE)/util/mkdirpth $@/ivl
	cp -pr examples_ivl/* $@/ivl
	@$(BASE)/util/mkdirpth $@/vbs
	cp -pr examples_vbs/* $@/vbs

package::
	$(MAKE)
	-rm -rf packages/root
	mkdir packages/root
	$(MAKE) INSTALL_PREFIX=packages/root$(prefix) install
	cd packages; make vl-$(OSNAME)

#####

#install: vl
#	$(INSTALL) -s -c -m 0755 $(INSTALL_USER) vl /usr/local/bin

VLDIR = ../packages/pkgfiles/vl-$(VERSION)
VLFILES ="\
  COPYING \
  ChangeLog \
  README \
  configure.in \
  examples_book \
  examples_ivl \
  examples_vbs \
  main.cc \
  verilog-manual.html \
  verilog.l \
  verilog.y \
  verilog_lex.cc \
  verilog_yacc.cc \
  verilog_yacc.h \
  vl_data.cc \
  vl_defs.h \
  vl_expr.cc \
  vl_gate.cc \
  vl_list.h \
  vl_obj.cc \
  vl_parse.cc \
  vl_print.cc \
  vl_sim.cc \
  vl_st.cc \
  vl_st.h \
  vl_sys.cc \
  vl_types.h"

export::
	if [ -d $(VLDIR) ]; then \
	    rm -rf $(VLDIR); \
	fi
	mkdir $(VLDIR)
	for a in $(VLFILES); do \
	    cp -pfr $$a $(VLDIR); \
	done 
	cp -pf ../../util/install-sh $(VLDIR)
	cp -pf ../../util/config.guess $(VLDIR)
	cp -pf ../../util/config.sub $(VLDIR)
	cp -pf ../miscutil/randval.cc $(VLDIR)
	cp -pf ../miscutil/randval.h $(VLDIR)
	sed s/XXVERSIONXX/$(VERSION)/ < Makefile_export.in >\
  $(VLDIR)/Makefile.in

#######################################################################
